
@{
    ViewBag.Title = "Upload";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Upload</h2>
<form>
    <div id="idPanelLogin">
        <input type="text" id="Rut" value=""/>
        <input type="password" id="PassWord" value="" />
        <input type="button" value="Acceder" id="IdEnviar" />
    </div>
    <div id="IdProcesando" class="hidden">Procesando...</div>
    <div id="idKey" class="hidden">
        <div class="datakey"></div>
        <input type="file" id="fileUpload" />
        <input type="button" value="cargar archivo" id="IdUpload" />
    </div>
</form>

@section Scripts
{
<script type="text/javascript">
        $('#IdEnviar').click(function(){
                // debugger;
                var rut = $("#Rut").val();
                var clave = $("#PassWord").val();
                var hola = { rut: rut, clave: clave };
                $("#IdProcesando").removeClass("hidden");
                $("#IdEnviar").addClass("hidden");
                $.ajax({
                    url: "http://localhost:9030/API-CLAAutomotora/Login",
                    type: "POST",
                    ContentType: "application/json",
                    data: hola,
                    success: function (data) {

                        //alert('Exito, posee la siguiente x-key: ' + data.key);
                        var xkay = data.key;
                        if (xkay != "") {
                            //alert("funciona?" + valorretorno);
                            $("#IdProcesando").addClass("hidden");
                            $('#idPanelLogin').addClass("hidden");
                            $('#idKey').removeClass("hidden");
                            $('#idKey div.datakey').append("Su x-Key: <span>"+xkay+"</span>");                        
                        }
                    },
                    error: function (msg) { alert("Error: Datos ingresados no son válidos, favor de verificar."); }
                });

    });


    $('#fileUpload').change(function (e) {
        alert(e.target.files);
        for (var i = 0, len = e.target.files.length; i < len; i++) {

                    var dataxkey = $('.datakey > span').text();
                    var file = $('#fileUpload').val();
                    var filename = file.replace(/C:\\fakepath\\/i, '');
            
                    fileData = document.getElementById('fileUpload').files[0];
                    var data = new FormData();
                    var endpoint = "http://localhost:9030/API-CLAAutomotora/Upload?nombrearchivo=" + fileData.name + "&sitio=1";

                    data.append('file', fileData);

                    $.ajax({
                        type: "POST",
                        url: endpoint,
                        headers: { 'x-key': dataxkey },
                        contentType: 'multipart/form-data',
                        processData: false,
                        data: data,
                        cache: false,
                        success: function (message) {
                            alert('Exito' + message);
                        },
                        error: function (message) {
                            alert('Error: ' + message.response);
                        }
                });
            
            }
    });
                


</script>
}